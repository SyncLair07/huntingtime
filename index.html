<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Before You Me</title>
    <style>

      :root {
        --bg-color: #f4f4f4;
        --text-color: #111;
        --accent-color: #555;
      }

      * {
            box-sizing: border-box;
        }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "Courier New", Courier, monospace;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        height: 100vh;     
        overflow: hidden;
      }

      .container {
        max-width: 480px;
        width: 100%;
        border-top: 2px solid var(--text-color);
        border-bottom: 2px solid var(--text-color);
        padding: 40px 0;
        max-height: 90vh; 
            overflow-y: auto;
        scrollbar-width: none; 
        -ms-overflow-style: none;
      }

      .container::-webkit-scrollbar { display: none; }

      h1 {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 40px;
        text-align: center;
      }

      .data-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .data-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 14px;
        border-bottom: 1px dashed #ccc;
        padding-bottom: 5px;
      }

      .label {
        color: var(--accent-color);
        text-transform: uppercase;
        font-size: 12px;
      }

      .value {
        font-weight: bold;
        text-align: right;       
        max-width: 60%;          
        word-wrap: break-word;   
        line-height: 1.3;        
        }

      button {
        width: 100%;
        padding: 20px;
        margin-top: 30px;
        background: var(--text-color);
        color: var(--bg-color);
        border: none;
        font-family: inherit;
        font-size: 14px;
        cursor: pointer;
        text-transform: uppercase;
      }

      button:disabled {
        opacity: 0.5;
        cursor: wait;
      }

      .hidden {
        display: none;
      }
      .note {
        font-size: 10px;
        color: #888;
        margin-top: 20px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="entry-view" class="container">
      <h1>Before You, Me</h1>
      <p style="font-size: 14px; line-height: 1.6; margin-bottom: 30px">
        This site holds one and only one record of its visitor<br /><br />
        If you would like to see who was here <b>before you</b>, <br>you would need to agree to leave your
        trace for the one who comes <b>after</b>.
      </p>
      <button id="exchange-btn">Agree & Exchange Data</button>
      <p class="note">Data collected: IP, Location, Battery, Device, Time.</p>
    </div>

    <div id="result-view" class="container hidden">
      <h1>The Visitor Before You</h1>
      <ul class="data-list" id="data-list"></ul>
      <p class="note">
        Your record is now active. Waiting for the next visitor...
      </p>
    </div>

    <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

            // === 配置区域 START ===
            
            const firebaseConfig = {

            apiKey: "AIzaSyBVcBJbWDVfpi5FLaoSnGg94v1mW19G8v8",

            authDomain: "beforeyoume-sklr.firebaseapp.com",

            databaseURL: "https://beforeyoume-sklr-default-rtdb.firebaseio.com",

            projectId: "beforeyoume-sklr",

            storageBucket: "beforeyoume-sklr.firebasestorage.app",

            messagingSenderId: "737305438592",

            appId: "1:737305438592:web:f6cdc936f5f796fa963965"

        };

            // === 配置区域 END ===

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const btn = document.getElementById('exchange-btn');
            const entryView = document.getElementById('entry-view');
            const resultView = document.getElementById('result-view');
            const list = document.getElementById('data-list');

            btn.addEventListener('click', async () => {
                btn.disabled = true;
                btn.innerText = "Connecting...";

                try {
                    
                    const [ipData, batteryStatus] = await Promise.all([
                        fetch('https://ipwho.is/').then(res => res.json()), 
                        getBatteryInfo()
                    ]);

                    const dpr = window.devicePixelRatio || 1;
                    const screenW = Math.round(window.screen.width * dpr);
                    const screenH = Math.round(window.screen.height * dpr);

                    const myData = {
                        time: new Date().toISOString(), 
                        location: `${ipData.city}, ${ipData.country}`,
                        ip: ipData.ip,
                        isp: ipData.connection ? ipData.connection.isp : 'Unknown ISP',
                        device: navigator.platform, 
                        screen: `${screenW} x ${screenH}`,
                        language: navigator.language,
                        battery: batteryStatus
                    };

                    
                    const snapshot = await get(child(ref(db), 'visitorRecord'));

                    
                    await set(ref(db, 'visitorRecord'), myData);

                    
                    if (snapshot.exists()) {
                        renderData(snapshot.val());
                    } else {
                        renderFirstTime();
                    }

                    entryView.classList.add('hidden');
                    resultView.classList.remove('hidden');

                } catch (error) {
                    console.error(error);
                    btn.innerText = "Error. Try Again.";
                    btn.disabled = false;
                }
            });

    
            async function getBatteryInfo() {
                if ('getBattery' in navigator) {
                    try {
                        const b = await navigator.getBattery();
                        const level = Math.round(b.level * 100) + "%";
                        const status = b.charging ? "Charging ⚡" : "Draining";
                        return `${level} (${status})`;
                    } catch (e) {
                        return "Unknown";
                    }
                }
                return "Unknown"; 
            }

            function timeAgo(dateString) {
                const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " years ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " months ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " days ago";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " hours ago";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutes ago";
                return Math.floor(seconds) + " seconds ago";
            }


            function renderData(data) {
                const fields = [
                    { label: "Last Seen", value: timeAgo(data.time) }, 
                    { label: "Location", value: data.location },
                    { label: "IP Address", value: data.ip },
                    { label: "Provider", value: data.isp },
                    { label: "System", value: data.device },
                    { label: "Battery", value: data.battery }, 
                    { label: "Screen", value: data.screen },
                    { label: "Language", value: data.language }
                ];

                list.innerHTML = fields.map(item => `
                    <li class="data-item">
                        <span class="label">${item.label}</span>
                        <span class="value">${item.value}</span>
                    </li>
                `).join('');
            }

            function renderFirstTime() {
                list.innerHTML = `<li class="data-item" style="display:block; text-align:center;">
                    You are the first. The cycle begins.
                </li>`;
            }
    </script>
  </body>
</html>
